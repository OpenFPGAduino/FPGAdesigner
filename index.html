<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="js/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <!--
  Author:  Zhizhou Li <lzz@meteroi.com>
 
  Copyright 2015 Meteroi
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
  -->
<title>Editor</title>
    
</head>
<body>


<script>
    var debug = false;
	function debuginf(string) {
		if (debug == true) {
			console.log(string);
		}
	}
	function ajax_rest_post(url, arg1, arg2) {
		var xhr = new XMLHttpRequest();
		var post;
		xhr.open("post",url,false);
		xhr.setRequestHeader( "Content-Type", "application/x-www-form-urlencoded")
		if (arg1 != undefined) 
			post = encodeURIComponent("arg1") + "=" + encodeURIComponent(arg1) + "&";
		else
			post = null;
		if (arg2 != undefined) 
			post += encodeURIComponent("arg2") + "=" + encodeURIComponent(arg2) + "&";
		xhr.send(post);
		debuginf(xhr.status);	
	}

	function load_example_list() {
		var xhr = new XMLHttpRequest();	
		xhr.open("get","load_example",false);
		xhr.send();
		var examplelist = xhr.responseText;
		var list = examplelist.split(',');
		var html_list = "";
		debuginf(list);
		for (var index in list) {
			debuginf(list[index]);
			var name = list[index].split('.')[0];
			var ext  = list[index].split('.')[1];
			if (ext == 'c') {
				html_list += "<span id=" + name + " onmousedown='mousedown(event)' onmouseup='mouseup(event)' class='btn btn-info'>" + name + "</span>";
			}
		}
		document.getElementById("Ex").innerHTML = html_list;
	}
	
	function get_design_part(verilog)
	{
		var verilog_lines = verilog.split('\n');
		var re = new RegExp("<Web_desing_part_start>");
		return str.match(re);
		var re = new RegExp("</Web_desing_part_start>");
		return str.match(re);

	}
	
	function is_function_type(str)
	{
		var re = new RegExp("\\.*\\s([^\\(\\s]+)\\(.*\\);");
		return str.match(re);
	}
	
	function is_comments(str)
	{
		var re = new RegExp(".*//(.*)");
		return str.match(re);
	}
	
	function load_api() {
		var xhr = new XMLHttpRequest();	
		xhr.open("get","grid.v",false);
		xhr.send();
		var api_doc = xhr.responseText;
		debuginf(api_doc);
		var api_doc_lines = api_doc.split('\n');
		debuginf(api_doc_lines);
		var html_list = "";
		var i = 0, j = 0;
		var math;
		var comments_html = "";
		while (i < api_doc_lines.length) {
			while(math = is_comments(api_doc_lines[i])) {
				comments_html += '<p>' + math[1] + '</p>';
				i++;
			}
			if(func = is_function_type(api_doc_lines[i])) {
				html_list += '<div class="panel panel-default"> \
				<div class="panel-heading"> \
				<a data-toggle="collapse" data-parent="#accordion" href="#collapse'+ j +'"> \
				<div class="alert alert-info" role="alert"><b>' + api_doc_lines[i] + '</b></div> \
				</a> \
				</div> \
				<div id="collapse'+ j + '" class="panel-collapse collapse"> \
				<div class="panel-body">' 
				j++;
				html_list += comments_html;
				html_list +=
				'</div> \
				</div> \
				</div>'
				comments_html = "";
                debuginf(func[1]);
			}
			i++;
		}
		debuginf(html_list);
		document.getElementById("accordion").innerHTML = html_list;
	}
	
	var dom = require("ace/lib/dom");
	//add command to all new editor instaces
	require("ace/commands/default_commands").commands.push({
		name: "Toggle Fullscreen",
		bindKey: "F11",
		exec: function(editor) {
			dom.toggleCssClass(document.body, "fullScreen")
			dom.toggleCssClass(editor.container, "fullScreen")
			editor.resize()
		}
	})
	
	// create first editor
	var editor = ace.edit("editor");
	editor.setTheme("ace/theme/tomorrow");
	editor.session.setMode("ace/mode/c_cpp");
	
	// event handle for webpage
	function save() {
		var code = editor.getValue();
		var file = document.getElementById("dialog_filename").value;
		debuginf("save");
		if (file != "") {
			ajax_rest_post("save", file, code);
			load_example_list();
			return true;
		} else
			return false;
	}
	
	function run() {
		var code = editor.getValue();
		debuginf("run");
		debuginf(code);
		ajax_rest_post("run",code);
	}
	
	function stop() {
		debuginf("stop");
		ajax_rest_post("stop");
	}
	
	function reboot() {
		debuginf("reboot");
		ajax_rest_post("reboot");
	}
	
	function configrations(event){
		var version = event.srcElement.innerText;
		document.getElementById('broadpic').src = 'config/'+version+'.jpg';
		debuginf("configrations");
		debuginf(version);
		ajax_rest_post("config",version);
	}
	
	function load_example(event) {
		var example = event.srcElement.innerText;
		debuginf(example);
		var file = example+'.c';
		debuginf("load code");
		var xhr = new XMLHttpRequest();	
		xhr.open("get","program/"+file,false);
		xhr.send();
		var get = xhr.responseText;
		debuginf(get);
		editor.setValue(get);
		editor.clearSelection();
	}
	

	var timer = null;
	function mousedown(event){
		load_example(event);
		timer = setTimeout(function() {delete_example(event)}, 1500 );//set the timeout
	};
	function mouseup(event){
		clearTimeout(timer);
	};
	
	function delete_example(event) {
		var file = event.srcElement.innerText;
		debuginf(file);
		document.getElementById("pop_message").innerText = file;	
		$("#popdialog").modal();
	}
	
	function do_delete_example()
	{
		file = document.getElementById("pop_message").innerText;	
		debuginf("do delete code");
		debuginf(file);
		ajax_rest_post("delete",file);
		load_example_list();
	}

	function clean_console() {
		document.getElementById("console").innerHTML = " ";	
	};	
	
	function clean_error() {
		document.getElementById("error").innerHTML = " ";	
	};			

	function console_polling(){
		var xhr = new XMLHttpRequest();	
		xhr.open("get","console",false);
		xhr.send();
		var get = xhr.responseText;
		get = get.replace(/\n/gi, '</p><p>');
		get = get.replace(/\r/gi, '</p><p>');
		document.getElementById("console").innerHTML += "<p>"+ get+"<\p>";
	}; 
	setInterval(console_polling, 1000);
	
	function error_polling(){
		var xhr = new XMLHttpRequest();	
		xhr.open("get","error",false);
		xhr.send();
		var get = xhr.responseText;
		get = get.replace(/\n/gi, '</p><p>');
		get = get.replace(/\r/gi, '</p><p>');
		document.getElementById("error").innerHTML += "<p>"+ get+"<\p>";
	}; 
	setInterval(error_polling, 1000);
    
	function delay_refresh() {
		window.location.reload(); 
	}
	function page_refresh() {
		setTimeout('delay_refresh()',60000); 

	}
	
	window.onload=function() {
		load_config_list();
		load_example_list();
	}
	
</script>

</body>
</html>
